// --- Constants ---
const GPAK        = 495;      // 5940 / 12
const VALVE_CV    = 0.5534;   // fixed valve Cv from 3.5 GPM @ 40 psi
const CHECK_CV    = 1.0360;   // fixed check-valve Cv from 6.552239 GPM @ 40 psi
const RATING_PSI  = 40;       // rating pressure for tip size (GPM @ 40 psi)

let lastSizingState = null;

// Look up the nozzle/orifice record from FLOW_DB
function getNozzleData(family, sizeKey){
  const famData = FLOW_DB[family];
  if (!famData) return null;
  return famData[sizeKey] || null;
}

// --- Cv + empirical flow helpers ---

// Tip Cv from rated flow at 40 psi (c = GPM @ 40 psi)
function tipCvFromRating(q40){
  if (!q40) return 0;
  return q40 / Math.sqrt(RATING_PSI);
}

// Total Cv of valve + tip + check in series
function totalCvForTip(tipCv){
  if (!tipCv) return 0;
  const invValve = 1 / (VALVE_CV * VALVE_CV);
  const invTip   = 1 / (tipCv * tipCv);
  const invCheck = 1 / (CHECK_CV * CHECK_CV);
  return 1 / Math.sqrt(invValve + invTip + invCheck);
}

// Nozzle (tip) pressure from boom/gauge pressure using series Cv physics
function nozzlePressureFromGauge(Pb, tipCv){
  if (!Pb || !tipCv) return 0;
  const cvTotal = totalCvForTip(tipCv);
  if (!cvTotal) return 0;
  const qStack = cvTotal * Math.sqrt(Pb);   // flow through stack at boom psi
  const ratio  = qStack / tipCv;           // Q = Cv_tip * sqrt(P_noz)
  return ratio * ratio;                    // P_noz = (Q / Cv_tip)^2
}

// Empirical nozzle flow from A/B data at a given nozzle pressure
function nozzleFlowEmpirical(Pn, coeff){
  if (!Pn || !coeff) return 0;
  // Q = a * P^b  (a,b from FLOW_DB)
  return coeff.a * Math.pow(Pn, coeff.b);
}









// Duty cycle target & quality bands (internal only)
const DC_OPT      = 75;  // target %
const DC_GOOD_LO  = 60;  // "good" band lower
const DC_GOOD_HI  = 100; // "good" band upper

// Aircraft → base nozzle count (no T-Boom)
const NOZZLE_BASE = {
  "AT-402": 94,
  "AT-502": 94,
  "AT-602": 106,
  "AT-802": 106
};

// Flow model from 2022 High Speed Spray Nozzle Models:
// Q(gpm) = a * P^b  (clamped by Cv)
const FLOW_DB = {
  "CP11TT 20° Flat Fan": {
    "4":  { a: 0.06636,  b: 0.48843,   c: 0.4,   d: 0.06,      e: 0.06,      F: 0.48  },
    "6":  { a: 0.095,    b: 0.4987,    c: 0.6,   d: 0.10,      e: 0.10,      F: 0.71  },
    "8":  { a: 0.124635, b: 0.50334,   c: 0.8,   d: 0.13,      e: 0.13,      F: 0.93  },
    "10": { a: 0.14959,  b: 0.51898,   c: 1.0,   d: 0.16,      e: 0.15,      F: 1.14  },
    "12": { a: 0.179398, b: 0.518838,  c: 1.2,   d: 0.19,      e: 0.18,      F: 1.35  },
    "15": { a: 0.23569,  b: 0.50193,   c: 1.5,   d: 0.24,      e: 0.22,      F: 1.62  },
    "20": { a: 0.31353,  b: 0.50233,   c: 2.0,   d: 0.32,      e: 0.27,      F: 2.02  }
  },

  "CP11TT 40° Flat Fan": {
    "4":  { a: 0.06636,  b: 0.48843,   c: 0.4,   d: 0.06,      e: 0.06,      F: 0.48  },
    "6":  { a: 0.095,    b: 0.4987,    c: 0.6,   d: 0.10,      e: 0.10,      F: 0.71  },
    "8":  { a: 0.124635, b: 0.50334,   c: 0.8,   d: 0.13,      e: 0.13,      F: 0.93  },
    "10": { a: 0.14959,  b: 0.51898,   c: 1.0,   d: 0.16,      e: 0.15,      F: 1.14  },
    "12": { a: 0.179398, b: 0.518838,  c: 1.2,   d: 0.19,      e: 0.18,      F: 1.35  },
    "15": { a: 0.23569,  b: 0.50193,   c: 1.5,   d: 0.24,      e: 0.22,      F: 1.62  },
    "20": { a: 0.31353,  b: 0.50233,   c: 2.0,   d: 0.32,      e: 0.27,      F: 2.02  },
    "25": { a: 0.37909,  b: 0.51492,   c: 2.5,   d: 0.41,      e: 0.31,      F: 2.34  },
    "30": { a: 0.4529,   b: 0.51599,   c: 3.0,   d: 0.49,      e: 0.35,      F: 2.59  }
  },

  "CP11TT 80° Flat Fan": {
    "2":  { a: 0.03263,  b: 0.4881,    c: 0.2,   d: 0.03,      e: 0.03,      F: 0.24  },
    "3":  { a: 0.04529,  b: 0.51365,   c: 0.3,   d: 0.05,      e: 0.05,      F: 0.36  },
    "4":  { a: 0.06636,  b: 0.48843,   c: 0.4,   d: 0.06,      e: 0.06,      F: 0.48  },
    "5":  { a: 0.077843, b: 0.50352,   c: 0.5,   d: 0.08,      e: 0.08,      F: 0.59  },
    "6":  { a: 0.095,    b: 0.4987,    c: 0.6,   d: 0.10,      e: 0.10,      F: 0.71  },
    "8":  { a: 0.124635, b: 0.50334,   c: 0.8,   d: 0.13,      e: 0.13,      F: 0.93  },
    "10": { a: 0.14959,  b: 0.51898,   c: 1.0,   d: 0.16,      e: 0.15,      F: 1.14  },
    "12": { a: 0.179398, b: 0.518838,  c: 1.2,   d: 0.19,      e: 0.18,      F: 1.35  },
    "15": { a: 0.23569,  b: 0.50193,   c: 1.5,   d: 0.24,      e: 0.22,      F: 1.62  },
    "20": { a: 0.31353,  b: 0.50233,   c: 2.0,   d: 0.32,      e: 0.27,      F: 2.02  },
    "25": { a: 0.37909,  b: 0.51492,   c: 2.5,   d: 0.41,      e: 0.31,      F: 2.34  },
    "30": { a: 0.4529,   b: 0.51599,   c: 3.0,   d: 0.49,      e: 0.35,      F: 2.59  }
  },

  "CP03": {
    "0.062": { a: 0.06793,   b: 0.578697, c: 0.0062, d: 0.00,     e: 0.00,     F: 0.01 },
    "0.078": { a: 0.15414,   b: 0.49788,  c: 0.0078, d: 0.00,     e: 0.00,     F: 0.01 },
    "0.125": { a: 0.38875,   b: 0.516055, c: 0.0125, d: 0.00,     e: 0.00,     F: 0.02 },
    "0.172": { a: 0.808131,  b: 0.460811, c: 0.0172, d: 0.00,     e: 0.00,     F: 0.02 }
  },

  "Steel Disc Core 45": {
    "2":  { a: 0.034075,  b: 0.48441,  c: 0.2,  d: 0.03,     e: 0.03,     F: 0.24 },
    "4":  { a: 0.058842,  b: 0.48849,  c: 0.4,  d: 0.06,     e: 0.06,     F: 0.48 },
    "6":  { a: 0.0870798, b: 0.514586, c: 0.6,  d: 0.10,     e: 0.10,     F: 0.71 },
    "8":  { a: 0.122721,  b: 0.521397, c: 0.8,  d: 0.13,     e: 0.13,     F: 0.93 },
    "10": { a: 0.159157,  b: 0.52275,  c: 1.0,  d: 0.16,     e: 0.15,     F: 1.14 },
    "12": { a: 0.196716,  b: 0.523962, c: 1.2,  d: 0.19,     e: 0.18,     F: 1.35 },
    "14": { a: 0.230042,  b: 0.51369,  c: 1.4,  d: 0.23,     e: 0.21,     F: 1.53 },
    "16": { a: 0.25906,   b: 0.523529, c: 1.6,  d: 0.26,     e: 0.23,     F: 1.71 }
  },

  "Ceramic Disc Core 45": {
    "2":  { a: 0.034075,  b: 0.48441,  c: 0.2,  d: 0.03,     e: 0.03,     F: 0.24 },
    "4":  { a: 0.058842,  b: 0.48849,  c: 0.4,  d: 0.06,     e: 0.06,     F: 0.48 },
    "6":  { a: 0.0870798, b: 0.514586, c: 0.6,  d: 0.10,     e: 0.10,     F: 0.71 },
    "8":  { a: 0.122721,  b: 0.521397, c: 0.8,  d: 0.13,     e: 0.13,     F: 0.93 },
    "10": { a: 0.159157,  b: 0.52275,  c: 1.0,  d: 0.16,     e: 0.15,     F: 1.14 }
  },

  "Standard 40° Flat Fan": {
    "2":  { a: 0.029049, b: 0.519085,  c: 0.2,  d: 0.03,     e: 0.03,     F: 0.24 },
    "4":  { a: 0.065176, b: 0.493859,  c: 0.4,  d: 0.06,     e: 0.06,     F: 0.48 },
    "6":  { a: 0.093974, b: 0.502175,  c: 0.6,  d: 0.10,     e: 0.10,     F: 0.71 },
    "8":  { a: 0.118101, b: 0.5616622, c: 0.8,  d: 0.13,     e: 0.13,     F: 0.93 },
    "10": { a: 0.15286,  b: 0.507496,  c: 1.0,  d: 0.16,     e: 0.15,     F: 1.14 },
    "12": { a: 0.176754, b: 0.51711,   c: 1.2,  d: 0.19,     e: 0.18,     F: 1.35 },
    "15": { a: 0.22734,  b: 0.509427,  c: 1.5,  d: 0.24,     e: 0.22,     F: 1.62 },
    "20": { a: 0.29049,  b: 0.519085,  c: 2.0,  d: 0.32,     e: 0.27,     F: 2.02 },
    "25": { a: 0.40032,  b: 0.494927,  c: 2.5,  d: 0.41,     e: 0.31,     F: 2.34 },
    "30": { a: 0.49563,  b: 0.494927,  c: 3.0,  d: 0.49,     e: 0.35,     F: 2.59 }
  },

  "Standard 80° Flat Fan": {
    "2":  { a: 0.029049, b: 0.519085,  c: 0.2,  d: 0.03,     e: 0.03,     F: 0.24 },
    "4":  { a: 0.065176, b: 0.493859,  c: 0.4,  d: 0.06,     e: 0.06,     F: 0.48 },
    "6":  { a: 0.093974, b: 0.502175,  c: 0.6,  d: 0.10,     e: 0.10,     F: 0.71 },
    "8":  { a: 0.118101, b: 0.5616622, c: 0.8,  d: 0.13,     e: 0.13,     F: 0.93 },
    "10": { a: 0.15286,  b: 0.507496,  c: 1.0,  d: 0.16,     e: 0.15,     F: 1.14 },
    "12": { a: 0.176754, b: 0.51711,   c: 1.2,  d: 0.19,     e: 0.18,     F: 1.35 },
    "15": { a: 0.22734,  b: 0.509427,  c: 1.5,  d: 0.24,     e: 0.22,     F: 1.62 },
    "20": { a: 0.29049,  b: 0.519085,  c: 2.0,  d: 0.32,     e: 0.27,     F: 2.02 },
    "25": { a: 0.40032,  b: 0.494927,  c: 2.5,  d: 0.41,     e: 0.31,     F: 2.34 },
    "30": { a: 0.49563,  b: 0.488603,  c: 3.0,  d: 0.49,     e: 0.35,     F: 2.59 }
  },

  "CP11TT Straight Stream": {
    "6":  { a: 0.095,    b: 0.4987,   c: 0.6,   d: 0.10,     e: 0.10,     F: 0.71 },
    "8":  { a: 0.124635, b: 0.50334,  c: 0.8,   d: 0.13,     e: 0.13,     F: 0.93 },
    "10": { a: 0.14959,  b: 0.51898,  c: 1.0,   d: 0.16,     e: 0.15,     F: 1.14 },
    "12": { a: 0.179398, b: 0.518838, c: 1.2,   d: 0.19,     e: 0.18,     F: 1.35 },
    "15": { a: 0.23569,  b: 0.50193,  c: 1.5,   d: 0.24,     e: 0.22,     F: 1.62 },
    "20": { a: 0.31353,  b: 0.50233,  c: 2.0,   d: 0.32,     e: 0.27,     F: 2.02 },
    "25": { a: 0.37909,  b: 0.51492,  c: 2.5,   d: 0.41,     e: 0.31,     F: 2.34 }
  },

  "Disc Core Straight Stream": {
    "2":  { a: 0.01942,  b: 0.63425,  c: 0.2,   d: 0.03,     e: 0.03,     F: 0.24 },
    "3":  { a: 0.03432,  b: 0.55706,  c: 0.3,   d: 0.05,     e: 0.05,     F: 0.36 },
    "4":  { a: 0.06428,  b: 0.5288,   c: 0.4,   d: 0.06,     e: 0.06,     F: 0.48 },
    "5":  { a: 0.11855,  b: 0.49621,  c: 0.5,   d: 0.08,     e: 0.08,     F: 0.59 },
    "6":  { a: 0.2,      b: 0.44944,  c: 0.6,   d: 0.10,     e: 0.10,     F: 0.71 },
    "7":  { a: 0.22658,  b: 0.495038, c: 0.7,   d: 0.11,     e: 0.11,     F: 0.82 },
    "8":  { a: 0.35376,  b: 0.44997,  c: 0.8,   d: 0.13,     e: 0.13,     F: 0.93 },
    "10": { a: 0.47806,  b: 0.47081,  c: 1.0,   d: 0.16,     e: 0.15,     F: 1.14 },
    "12": { a: 0.56108,  b: 0.49034,  c: 1.2,   d: 0.19,     e: 0.18,     F: 1.35 }
  },

  "Davidon TriSet": {
    "0.061": { a: 0.107668, b: 0.494927, c: 0.0061, d: 0.00,    e: 0.00,    F: 0.01 },
    "0.078": { a: 0.171653, b: 0.488799, c: 0.0078, d: 0.00,    e: 0.00,    F: 0.01 },
    "0.125": { a: 0.381699, b: 0.500123, c: 0.0125, d: 0.00,    e: 0.00,    F: 0.02 }
  },

  "CP09": {
    "0.062": { a: 0.06793,   b: 0.578697, c: 0.57,  d: 0.09,    e: 0.09,    F: 0.67 },
    "0.078": { a: 0.15414,   b: 0.49788,  c: 0.97,  d: 0.16,    e: 0.15,    F: 1.11 },
    "0.125": { a: 0.38875,   b: 0.516055, c: 2.61, d: 0.42,    e: 0.32,    F: 2.40 },
    "0.172": { a: 0.808131,  b: 0.460811, c: 4.42, d: 0.72,    e: 0.41,    F: 3.04 }
  },

  "TeeJet SS": {
    "2":  { a: 0.031243,   b: 0.501353,  c: 0.2,  d: 0.03,    e: 0.03,    F: 0.24 },
    "3":  { a: 0.046759,   b: 0.503775,  c: 0.3,  d: 0.05,    e: 0.05,    F: 0.36 },
    "4":  { a: 0.0622774,  b: 0.5049686, c: 0.4,  d: 0.06,    e: 0.06,    F: 0.48 },
    "6":  { a: 0.09351724, b: 0.5037751, c: 0.6,  d: 0.10,    e: 0.10,    F: 0.71 },
    "8":  { a: 0.127919,   b: 0.4967165, c: 0.8,  d: 0.13,    e: 0.13,    F: 0.93 },
    "10": { a: 0.158941,   b: 0.501353,  c: 1.0,  d: 0.16,    e: 0.15,    F: 1.14 },
    "12": { a: 0.216582,   b: 0.467888,  c: 1.2,  d: 0.19,    e: 0.18,    F: 1.35 },
    "15": { a: 0.236942,   b: 0.503775,  c: 1.5,  d: 0.24,    e: 0.22,    F: 1.62 },
    "20": { a: 0.314942,   b: 0.5049686, c: 2.0,  d: 0.32,    e: 0.27,    F: 2.02 },
    "25": { a: 0.405553553,b: 0.494927,  c: 2.5,  d: 0.41,    e: 0.31,    F: 2.34 },
    "30": { a: 0.486664263,b: 0.494927,  c: 3.0,  d: 0.49,    e: 0.35,    F: 2.59 }
  },

  "TeeJet H1 4U": {
    "2":  { a: 0.031243,   b: 0.501353,  c: 0.2,  d: 0.03,    e: 0.03,    F: 0.24 },
    "3":  { a: 0.046759,   b: 0.503775,  c: 0.3,  d: 0.05,    e: 0.05,    F: 0.36 },
    "4":  { a: 0.0622774,  b: 0.5049686, c: 0.4,  d: 0.06,    e: 0.06,    F: 0.48 },
    "6":  { a: 0.09351724, b: 0.5037751, c: 0.6,  d: 0.10,    e: 0.10,    F: 0.71 },
    "8":  { a: 0.127919,   b: 0.4967165, c: 0.8,  d: 0.13,    e: 0.13,    F: 0.93 },
    "10": { a: 0.158941,   b: 0.499091,  c: 1.0,  d: 0.16,    e: 0.15,    F: 1.14 },
    "12": { a: 0.216582,   b: 0.467888,  c: 1.2,  d: 0.19,    e: 0.18,    F: 1.35 },
    "15": { a: 0.236942,   b: 0.50032,   c: 1.5,  d: 0.24,    e: 0.22,    F: 1.62 },
    "20": { a: 0.314942,   b: 0.5009387, c: 2.0,  d: 0.32,    e: 0.27,    F: 2.02 },
	"25": { a: 0.405553553,b: 0.494927,  c: 2.5,  d: 0.41,    e: 0.31,    F: 2.34 },
    "30": { a: 0.486664263,b: 0.494927,  c: 3.0,  d: 0.49,    e: 0.35,    F: 2.59 }
  }
};

// --- Droplet Core (USDA atomization model) ---
// NOTE: this is the same regression model used in DropletData.html,
// but SwathPro only calls evaluateNozzleDroplet() and not the guts.

/**
 * DROPLET_DB holds CCD-coded regressions for USDA high-speed spray tests.
 * Only families present here will return droplet data.
 */
const DROPLET_DB = {
  "CP03": {
    ccd: {
      orfSub: 0.1165,
      orfDiv: 0.0555,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 60,
      angDiv: 30,
    },
	angles: [30, 55, 90],   // ← ADD THIS LINE
    dv01: [
      82.87720122,
      3.2460530517,
      -22.57192844,
      6.3481208565,
      -56.95,
      -5.6625,
      2.9125,
      2.6625,
      -8.05,
      14.05,
      -6.2,
      -3.1571938605,
      4.1650954784,
      0.5650954784,
      15.315095478
    ],
    dv05: [
      198.7792551,
      16.36749058,
      -52.6884686,
      12.975048903,
      -114.05,
      -13.025,
      7.1125,
      5.0625,
      -16.95,
      28.4,
      -12.575,
      -5.664678467,
      8.3327005444,
      1.2327005444,
      30.182700544
    ],
    dv09: [
      359.3420753,
      50.51741593,
      -109.3463618,
      6.0168888889,
      -171.05,
      -9.5,
      4.7625,
      4.6375,
      -25.3,
      43.975,
      -19.3375,
      -15.83060237,
      9.5050502551,
      1.1550502551,
      44.105050255
    ],
    vlt100: [
      23.20784173,
      8.8330878021,
      -5.8119515531,
      5.4778441001,
      10.5762963,
      -0.7083333333,
      -0.0416666667,
      -0.8166666667,
      1.6407407407,
      0.7361111111,
      0.7986111111,
      -3.2097527585,
      1.1256233907,
      0.4756233907,
      3.3256233907
    ],
    vlt200: [
      45.49110511,
      -9.6485259552,
      13.035434228,
      0.8416975309,
      26.16666667,
      1.4694444444,
      -0.4,
      -0.6916666667,
      1.7833333333,
      -0.3722222222,
      1.0833333333,
      -0.613071513,
      1.8922025149,
      0.8422025149,
      3.6922025149
    ],
  },
  "CP09": {
    ccd: {
      orfSub: 0.117,
      orfDiv: 0.055,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 15,
      angDiv: 15,
    },
	angles: [0, 5, 30],
    dv01: [
      62.27593752,
      -5.0615939847,
      -41.38493853,
      10.462539817,
      -83.9,
      -11.125,
      6.3625,
      3.8375,
      -7.85,
      30.2,
      -17.575,
      -6.017562624,
      10.278846739,
      2.928846739,
      32.878846739
    ],
    dv05: [
      109.2069857,
      -10.946595383,
      -112.5253385,
      18.301926504,
      -119.1,
      -21.45,
      11.375,
      6.25,
      -13.975,
      52.525,
      -30.3,
      -14.258605468,
      18.499890855,
      4.5998908552,
      52.449890855
    ],
    dv09: [
      300.8848201,
      25.45147359,
      -214.0946506,
      8.0024463149,
      -126.9,
      -10.25,
      5.7625,
      4.6,
      -15.4,
      48.175,
      -26.55,
      -31.434376341,
      14.017602778,
      3.5676027784,
      47.417602778
    ],
    vlt100: [
      5.395885869,
      -1.9860552884,
      16.284497505,
      5.4576151483,
      -3.40734375,
      0.6180555556,
      -0.1638888889,
      -0.4,
      0.8972222222,
      -0.75,
      -0.2861111111,
      -0.6772828407,
      1.8508417596,
      0.8008417596,
      3.6508417596
    ],
    vlt200: [
      41.06994017,
      -3.40734375,
      16.284497505,
      0.3732947531,
      13.24687438,
      1.3166666667,
      -0.3444444444,
      -0.8388888889,
      1.4305555556,
      0.375,
      0.7722222222,
      -3.9969100695,
      1.9022203469,
      0.8522203469,
      3.7022203469
    ],
  },
  "CP11TT 20° Flat Fan": {
    ccd: {
      orfSub: 12,
      orfDiv: 8,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      87.494915254,
      14.505555556,
      -28.45555556,
      6.2888888889,
      -49.25,
      -6.1125,
      3.3125,
      1.9125,
      -4.55,
      14.6,
      -6.125,
      -4.82740113,
      4.8225988701,
      0.9225988701,
      15.67259887
    ],
    dv05: [
      217.3830508,
      34.12222222,
      -62.21111111,
      12.772222222,
      -102.85,
      -12.9,
      7.125,
      4.925,
      -11.9,
      29.25,
      -12.8,
      -6.846111111,
      8.9748842593,
      1.8748842593,
      29.724884259
    ],
    dv09: [
      382.3559322,
      85.55,
      -115.9388889,
      7.4053570797,
      -161.15,
      -10.35,
      5.6875,
      4.85,
      -16.675,
      44.9,
      -19.45,
      -15.540969207,
      9.396655982,
      1.296655982,
      44.146655982
    ],
    vlt100: [
      19.06819723,
      6.535157926,
      -4.2216730365,
      4.6037037037,
      10.24398148,
      -0.8611111111,
      -0.0416666667,
      -0.8611111111,
      1.6537037037,
      0.9166666667,
      0.7861111111,
      -2.7632354761,
      1.0321286002,
      0.3821286002,
      3.2321286002
    ],
    vlt200: [
      42.96898148,
      0.747531746,
      13.921740134,
      0.5320987654,
      17.02824074,
      0.7305555556,
      -0.1777777778,
      -0.7111111111,
      1.3166666667,
      0.8125,
      0.5041666667,
      -1.6551982011,
      1.4477534699,
      0.7977534699,
      3.6477534699
    ],
  },
  "CP11TT 40° Flat Fan": {
    ccd: {
      orfSub: 17,
      orfDiv: 13,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      82.84865997,
      9.8470930498,
      -24.89310981,
      7.817833935,
      -47.05,
      -10.325,
      5.5625,
      3.7125,
      -3.7,
      17.7,
      -9.575,
      -3.7694574324,
      5.4045300048,
      0.7545300048,
      15.604530005
    ],
    dv05: [
      208.4340327,
      30.96142553,
      -57.69716513,
      13.280223088,
      -101.85,
      -15.275,
      7.5125,
      5.15,
      -11.4,
      31.725,
      -15.5,
      -5.9993662089,
      9.0370330103,
      1.9370330103,
      29.78703301
    ],
    dv09: [
      368.0412398,
      82.72361111,
      -106.5265994,
      7.4053570797,
      -158.65,
      -12.3,
      5.8875,
      5.425,
      -16.825,
      47.025,
      -21.75,
      -14.776849104,
      9.5006135518,
      1.4006135518,
      43.250613552
    ],
    vlt100: [
      18.32883584,
      5.6538427312,
      -3.6245207044,
      4.713128907,
      10.39339506,
      -0.7506944444,
      -0.0166666667,
      -0.7666666667,
      1.6083333333,
      0.8902777778,
      0.8680555556,
      -2.9431919053,
      1.0699095461,
      0.4199095461,
      3.2699095461
    ],
    vlt200: [
      41.52077713,
      -0.0577146807,
      13.317529324,
      0.5648417691,
      15.2494319,
      0.78,
      -0.1766666667,
      -0.7166666667,
      1.3458333333,
      0.8208333333,
      0.4833333333,
      -1.8425023698,
      1.4936555873,
      0.8436555873,
      3.6936555873
    ],
  },
  "CP11TT 60° Flat Fan": {
    ccd: {
      orfSub: 0,
      orfDiv: 1,
      asSub: 150,
      asDiv: 30,
      pressSub: 45,
      pressDiv: 15,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      75.65233333,
      0,
      -28.41885833,
      7.4053570797,
      -41.7,
      -9.3875,
      5.225,
      3.75,
      -3.15,
      18.2,
      -10.525,
      -4.2060487959,
      5.5330071647,
      0.8830071647,
      15.733007165
    ],
    dv05: [
      195.1749,
      0,
      -62.6289,
      13.035434228,
      -93.45,
      -17.3375,
      8.2625,
      5.8,
      -10.025,
      31.55,
      -15.675,
      -5.7006571641,
      9.2732357009,
      2.1732357009,
      29.023235701
    ],
    dv09: [
      345.5937583,
      0,
      -105.2179667,
      8.942846175,
      -147.65,
      -13.8,
      7.15,
      5.95,
      -13.35,
      45.05,
      -21.3,
      -14.55396626,
      9.7587474887,
      1.6587474887,
      43.508747489
    ],
    vlt100: [
      17.41285508,
      0,
      -4.1185370309,
      4.6037037037,
      10.0308642,
      -0.8763888889,
      -0.0194444444,
      -0.8847222222,
      1.6569444444,
      0.8861111111,
      0.88,
      -2.6904626585,
      1.0673850859,
      0.4173850859,
      3.2673850859
    ],
    vlt200: [
      40.09865527,
      0,
      14.248092704,
      0.5648417691,
      12.1557981,
      0.8173611111,
      -0.1798611111,
      -0.7583333333,
      1.3861111111,
      0.8208333333,
      0.4888888889,
      -1.5934903537,
      1.4341601993,
      0.7841601993,
      3.6341601993
    ],
  },
  "CP11TT 80° Flat Fan": {
    ccd: {
      orfSub: 16,
      orfDiv: 14,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      80.39107824,
      15.380074302,
      -19.14014325,
      7.4053570797,
      -48.3,
      -9.5,
      5.3125,
      4.3625,
      -4.6,
      20.875,
      -12.35,
      -3.7323297367,
      5.6859130407,
      1.0359130407,
      15.885913041
    ],
    dv05: [
      198.7351434,
      40.90783257,
      -41.15219441,
      13.035434228,
      -102.4,
      -16.8125,
      8.3875,
      5.875,
      -10.65,
      35.1,
      -18.175,
      -5.4362202677,
      9.6261408472,
      2.5261408472,
      29.376140847
    ],
    dv09: [
      345.2431167,
      87.85842593,
      -66.27101267,
      8.942846175,
      -155.95,
      -16.025,
      9.1625,
      6.8875,
      -12.425,
      43.7,
      -20.0625,
      -14.627260233,
      10.269044495,
      2.169044495,
      44.019044495
    ],
    vlt100: [
      16.89866372,
      5.6807350865,
      -3.7003319559,
      4.713128907,
      10.29313264,
      -0.7541666667,
      -0.0416666667,
      -0.7583333333,
      1.6111111111,
      0.8888888889,
      0.9152777778,
      -2.8625796734,
      1.0608369693,
      0.4108369693,
      3.2608369693
    ],
    vlt200: [
      39.78459721,
      0.4606282167,
      13.790003394,
      0.5320987654,
      14.44711852,
      0.6902777778,
      -0.1722222222,
      -0.7027777778,
      1.3361111111,
      0.8125,
      0.5395833333,
      -1.7721957344,
      1.4942650796,
      0.8442650796,
      3.6942650796
    ],
  },
  "CP11TT Straight Stream": {
    ccd: {
      orfSub: 15.5,
      orfDiv: 9.5,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 22.5,
      angDiv: 22.5,
    },
	angles: [0, 15, 30, 45],
    dv01: [
      119.4534747,
      -10.187185199,
      -54.71966667,
      4.1525234699,
      -92,
      -10.475,
      5.85,
      4.6625,
      -8.925,
      31,
      -16.9375,
      -10.879288955,
      8.0338139411,
      1.3838139411,
      16.233813941
    ],
    dv05: [
      252.3657053,
      -9.9417689802,
      -127.5480648,
      9.8440646852,
      -137.6,
      -16.8625,
      8.6625,
      6.4,
      -14.1,
      49.2,
      -26.3,
      -22.39689955,
      13.367735704,
      2.467735704,
      30.217735704
    ],
    dv09: [
      451.2931161,
      36.8221953,
      -233.8423148,
      10.276437442,
      -167.1,
      -16.7625,
      8.4875,
      6.3,
      -14.425,
      51.95,
      -27.6,
      -47.523585373,
      14.752497353,
      2.802497353,
      45.652497353
    ],
    vlt100: [
      7.764796349,
      0.1518989689,
      11.322816037,
      3.5759259259,
      6.979938272,
      -0.0368055556,
      0.0458333333,
      -0.2118055556,
      0.3703703704,
      0.1361111111,
      0.1472222222,
      -1.5296796532,
      0.7140211382,
      0.0640211382,
      2.9140211382
    ],
    vlt200: [
      28.97009229,
      -0.8015103554,
      11.436174689,
      0.4030864198,
      11.74328704,
      0.4625,
      -0.0868055556,
      -0.3701388889,
      0.7472222222,
      0.3541666667,
      0.3722222222,
      -2.7283060363,
      1.1857658519,
      0.5357658519,
      3.3857658519
    ],
  },
  "Ceramic Disc Core 45": {
    ccd: {
      orfSub: 6,
      orfDiv: 4,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      71.18469491,
      10.061815178,
      -17.17031482,
      10.195134944,
      -40.6,
      -9.7625,
      5.2,
      3.7875,
      -2.8,
      17.025,
      -9.775,
      -3.7114685058,
      5.2830359011,
      0.6330359011,
      15.483035901
    ],
    dv05: [
      176.9451075,
      27.35135209,
      -37.03585185,
      14.888888889,
      -90.6,
      -15.1375,
      7.7375,
      5.6875,
      -9.55,
      32.35,
      -16.8,
      -5.1900371741,
      9.4295205338,
      1.8295205338,
      29.679520534
    ],
    dv09: [
      333.1581129,
      57.96183333,
      -69.99429629,
      10.195134944,
      -143.45,
      -15.4875,
      8.5,
      6.4,
      -11.975,
      41.825,
      -21.0875,
      -14.374983441,
      10.092777778,
      1.9927777778,
      43.842777778
    ],
    vlt100: [
      17.259141,
      5.7138428313,
      -3.7172353982,
      4.4074074074,
      10.02988757,
      -0.8402777778,
      -0.0590277778,
      -0.8222222222,
      1.6375,
      0.8388888889,
      0.8923611111,
      -2.6326758793,
      1.0562365622,
      0.4062365622,
      3.2562365622
    ],
    vlt200: [
      40.11774128,
      0.0577099357,
      13.241374583,
      0.537654321,
      12.76429938,
      0.7208333333,
      -0.1875,
      -0.7118055556,
      1.3861111111,
      0.8222222222,
      0.4895833333,
      -1.6201024313,
      1.4537905929,
      0.8037905929,
      3.6537905929
    ],
  },
  "Davidon TriSet": {
    ccd: {
      orfSub: 0.0935,
      orfDiv: 0.0315,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 22.5,
      angDiv: 22.5,
    },
	angles: [0, 22.5, 45],
    dv01: [
      102.5434956,
      -7.7112453813,
      -54.64655198,
      5.8659956038,
      -81.05,
      -10.45,
      6.0625,
      3.8625,
      -8.1,
      28.45,
      -15.2375,
      -8.5184344727,
      7.3564781898,
      0.7064781898,
      15.55647819
    ],
    dv05: [
      227.3621564,
      -2.7662385003,
      -130.1937109,
      9.8440646852,
      -132.9,
      -18.5625,
      9.6125,
      6.0125,
      -14.5,
      45.95,
      -24.75,
      -18.089653837,
      12.719351028,
      2.8193510283,
      30.569351028
    ],
    dv09: [
      420.4475001,
      26.98325127,
      -246.1202778,
      10.276437442,
      -169.05,
      -18.5875,
      9.4625,
      5.95,
      -14.925,
      53.075,
      -28.325,
      -42.779871102,
      14.629869885,
      2.6798698854,
      45.529869885
    ],
    vlt100: [
      9.049676268,
      0.3543417925,
      10.108090443,
      3.5759259259,
      7.264722222,
      0.0368055556,
      0.0583333333,
      -0.1993055556,
      0.3675925926,
      0.1416666667,
      0.1652777778,
      -1.7314838601,
      0.7485739175,
      0.0985739175,
      2.9485739175
    ],
    vlt200: [
      30.13134636,
      -18.87821382,
      9.5579343148,
      0.4030864198,
      11.13292769,
      0.4902777778,
      -0.1020833333,
      -0.3645833333,
      0.7333333333,
      0.3777777778,
      0.4020833333,
      -3.2776034719,
      1.2756442011,
      0.6256442011,
      3.4756442011
    ],
  },
  "Disc Core Straight Stream": {
    ccd: {
      orfSub: 7,
      orfDiv: 5,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 22.5,
      angDiv: 22.5,
    },
	angles: [0, 15, 30, 45],
    dv01: [
      127.1901811,
      -13.25509309,
      -54.41960317,
      4.1650954784,
      -98.9,
      -10.4625,
      5.5625,
      4.75,
      -10.075,
      32.2,
      -16.45,
      -11.69726671,
      8.3309378672,
      1.6809378672,
      16.530937867
    ],
    dv05: [
      272.0092454,
      -12.3332362,
      -131.2386111,
      9.8440646852,
      -143.6,
      -18.375,
      9.525,
      6.2375,
      -15.85,
      47.1,
      -26.2,
      -23.796102819,
      13.300641815,
      2.900641815,
      30.750641815
    ],
    dv09: [
      471.8031811,
      33.17127238,
      -233.0765809,
      10.276437442,
      -177.2,
      -19.3625,
      9.9375,
      6.4625,
      -16.45,
      53.025,
      -28.8625,
      -50.765018053,
      15.271393754,
      3.2213937543,
      46.071393754
    ],
    vlt100: [
      8.997231863,
      1.6691643655,
      10.276437442,
      3.4814814815,
      7.070049603,
      0.1555555556,
      0.0333333333,
      -0.1930555556,
      0.3666666667,
      0.1347222222,
      0.1611111111,
      -1.6517113049,
      0.7479987958,
      0.0979987958,
      2.9479987958
    ],
    vlt200: [
      30.24250198,
      -0.6722991453,
      9.7332762429,
      0.4030864198,
      11.19448886,
      0.4847222222,
      -0.1118055556,
      -0.3631944444,
      0.7333333333,
      0.3819444444,
      0.3986111111,
      -2.6738228916,
      1.2762800539,
      0.6262800539,
      3.4762800539
    ],
  },
  "Standard 40° Flat Fan": {
    ccd: {
      orfSub: 16,
      orfDiv: 14,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      85.60496231,
      9.583805868,
      -22.16106126,
      7.7709127999,
      -48.85,
      -11.0875,
      5.6125,
      3.9875,
      -3.95,
      18.25,
      -9.7375,
      -3.7119414693,
      5.5483126577,
      0.8983126577,
      15.748312658
    ],
    dv05: [
      223.0997927,
      39.6139165,
      -52.04873394,
      13.317529324,
      -107.1,
      -16.775,
      8.3,
      5.7125,
      -11.4,
      33.35,
      -17.25,
      -5.9164997063,
      9.4824629746,
      2.3824629746,
      29.232462975
    ],
    dv09: [
      401.7904675,
      95.06610191,
      -86.99491956,
      12.155798097,
      -163.8,
      -18.725,
      9.875,
      7.825,
      -12.625,
      43.95,
      -20.7375,
      -16.006353385,
      11.971739279,
      3.3217392794,
      45.171739279
    ],
    vlt100: [
      17.15753703,
      6.2067594515,
      -3.817411449,
      4.6438271605,
      9.98441358,
      -0.8361111111,
      -0.0333333333,
      -0.8472222222,
      1.65,
      0.8527777778,
      0.9104166667,
      -2.6557553694,
      1.0574456975,
      0.4074456975,
      3.2574456975
    ],
    vlt200: [
      42.57349537,
      -1.077643214,
      15.336443593,
      0.5732098765,
      15.69888372,
      0.7972222222,
      -0.1625,
      -0.7208333333,
      1.3458333333,
      0.8305555556,
      0.4944444444,
      -2.0500365089,
      1.5057732923,
      0.8557732923,
      3.7057732923
    ],
  },
  "Standard 80° Flat Fan": {
    ccd: {
      orfSub: 16,
      orfDiv: 14,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      80.83205859,
      9.1461848343,
      -17.19349041,
      7.0525603554,
      -44.9,
      -10.575,
      5.0375,
      3.5125,
      -3.55,
      17.825,
      -9.7625,
      -3.290969873,
      5.1218207731,
      0.4718207731,
      15.321820773
    ],
    dv05: [
      206.7940212,
      36.07870427,
      -40.26813286,
      14.447118525,
      -99.7,
      -16.125,
      7.8625,
      5.95,
      -10.35,
      34.1,
      -17.4,
      -5.3276947294,
      9.2022470589,
      2.1022470589,
      28.952247059
    ],
    dv09: [
      370.7755245,
      83.11374107,
      -67.99461483,
      13.317529324,
      -150.5,
      -18.35,
      9.5125,
      7.225,
      -12.025,
      42.75,
      -19.8125,
      -14.045666852,
      11.171037777,
      2.5210377774,
      44.021037777
    ],
    vlt100: [
      17.04076217,
      6.0432718756,
      -3.6753395487,
      4.7527777778,
      9.839465608,
      -0.8333333333,
      -0.0208333333,
      -0.85,
      1.6555555556,
      0.8666666667,
      0.8930555556,
      -2.558409068,
      1.039538305,
      0.389538305,
      3.239538305
    ],
    vlt200: [
      43.60337813,
      -1.9590889658,
      15.698883723,
      0.5648417691,
      14.67388035,
      0.7881944444,
      -0.1736111111,
      -0.7291666667,
      1.3583333333,
      0.8291666667,
      0.5,
      -2.8222509415,
      1.4875807024,
      0.8375807024,
      3.6875807024
    ],
  },
  "Steel Disc Core 45": {
    ccd: {
      orfSub: 9,
      orfDiv: 7,
      asSub: 150,
      asDiv: 30,
      pressSub: 60,
      pressDiv: 30,
      angSub: 45,
      angDiv: 45,
    },
	angles: [0, 15, 30, 45, 60, 75, 90],
    dv01: [
      71.07988372,
      6.4082779575,
      -17.77781759,
      7.4053570797,
      -40.1,
      -9.8375,
      5.25,
      3.8375,
      -2.575,
      17.875,
      -9.9125,
      -3.8409876543,
      5.3527314815,
      0.7027314815,
      15.552731481
    ],
    dv05: [
      179.4538831,
      23.3015738,
      -35.55823255,
      14.423020362,
      -90.6,
      -15.2875,
      7.8625,
      5.8,
      -9.375,
      32.5,
      -16.8625,
      -5.0827160494,
      9.424691358,
      1.824691358,
      29.674691358
    ],
    dv09: [
      350.5048621,
      54.76342593,
      -63.14502177,
      12.155798097,
      -147.3,
      -16.0375,
      8.4,
      6.85,
      -11.575,
      42.25,
      -20.425,
      -14.051831275,
      10.582097577,
      1.932097577,
      43.782097577
    ],
    vlt100: [
      16.96242016,
      5.6937080953,
      -3.7363818039,
      4.4614197531,
      10.01725353,
      -0.8263888889,
      -0.0631944444,
      -0.8298611111,
      1.6319444444,
      0.8381944444,
      0.9,
      -2.7169363414,
      1.0623668982,
      0.4123668982,
      3.2623668982
    ],
    vlt200: [
      40.2696712,
      -0.0145283022,
      13.317529324,
      0.5787654321,
      12.59717046,
      0.7361111111,
      -0.2034722222,
      -0.7104166667,
      1.4,
      0.8222222222,
      0.4930555556,
      -1.631778754,
      1.4762110665,
      0.8262110665,
      3.6762110665
    ],
  },
  "TeeJet H1 4U": {
    ccd: {
      orfSub: 11,
      orfDiv: 9,
      asSub: 150.5,
      asDiv: 30.5,
      pressSub: 59.5,
      pressDiv: 32.5,
      angSub: 0,
      angDiv: 1,
    },
	angles: [0],
    dv01: [
      175.4378527,
      -18.6044916,
      -151.667749,
      6.3481208565,
      0,
      13.280223088,
      -9.5196040154,
      -57.61296297,
      0,
      0,
      0,
      4.7729928201,
      79.87625261,
      -1.3134410352,
      0
    ],
    dv05: [
      415.9378447,
      -9.6374015744,
      -311.3765459,
      14.423020362,
      0,
      17.23580247,
      -21.16070727,
      -100.2597979,
      0,
      0,
      0,
      -1.3717536105,
      163.2439397,
      -10.62373936,
      0
    ],
    dv09: [
      708.117974,
      34.5091106,
      -440.0303073,
      14.423020362,
      0,
      30.56662972,
      -26.58001087,
      -151.248811,
      0,
      0,
      0,
      -25.813430799,
      255.1113609,
      -21.18800446,
      0
    ],
    vlt100: [
      43.18345888,
      6.9082160629,
      -9.9981506113,
      4.137037037,
      0,
      8.5192901235,
      -1.4393117981,
      -7.50364973,
      0,
      0,
      0,
      -2.0165404894,
      89.549632645,
      -7.7706083167,
      0
    ],
    vlt200: [
      98.24527199,
      10.83110928,
      -27.9240967,
      0.5552469136,
      0,
      12.01998687,
      0.1974486373,
      -5.33218245,
      0,
      0,
      0,
      -3.7212637521,
      -17.04162844,
      6.8083710197,
      0
    ],
  },
  "TeeJet SS": {
    ccd: {
      orfSub: 11,
      orfDiv: 9,
      asSub: 153,
      asDiv: 33,
      pressSub: 58,
      pressDiv: 35,
      angSub: 0,
      angDiv: 1,
    },
	angles: [0],
    dv01: [
      167.6182844,
      -10.4984518,
      -125.3889639,
      49.711825595,
      0,
      13.318392298,
      -9.437618556,
      -52.882576334,
      0,
      0,
      0,
      4.5908133905,
      78.265559057,
      -1.4814114619,
      0
    ],
    dv05: [
      404.5737661,
      -5.04881263,
      -265.4375655,
      102.86490831,
      0,
      17.956842228,
      -21.16070727,
      -100.2597979,
      0,
      0,
      0,
      -1.3739815246,
      163.2439397,
      -10.62373936,
      0
    ],
    dv09: [
      698.6510327,
      33.4854732,
      -408.2854095,
      102.86490831,
      0,
      34.456373333,
      -26.58001087,
      -151.248811,
      0,
      0,
      0,
      -25.951160321,
      255.1113609,
      -21.18800446,
      0
    ],
    vlt100: [
      39.49042188,
      7.2056434962,
      -8.3388492458,
      4.2796296296,
      0,
      6.6847790123,
      -1.10994619,
      -7.3795096,
      0,
      0,
      0,
      -1.852771226,
      89.10592945,
      -7.7692433859,
      0
    ],
    vlt200: [
      92.11077646,
      10.87469284,
      -27.30175476,
      0.5552469136,
      0,
      11.86248682,
      0.564842452,
      -5.33218245,
      0,
      0,
      0,
      -3.4717988769,
      -17.56019933,
      6.838132125,
      0
    ],
  }
};


// DV thresholds from Reference Nozzles (USDA bands)
const DV_THRESHOLDS = {
  dv01: [59.5, 110.3, 162.0, 191.7, 226.1, 302.5],
  dv05: [134.4, 248.1, 357.8, 431.0, 500.9, 658.6],
  dv09: [236.4, 409.4, 584.0, 737.1, 819.8, 1142.2]
};

const DSC_LABELS = {
  1: "VERY FINE",
  2: "FINE",
  3: "MEDIUM",
  4: "COARSE",
  5: "VERY COARSE",
  6: "EXT. COARSE",
  7: "ULT. COARSE"
};

function codeVariablesDroplet(cfg, orifice, airspeed, pressure, angle) {
  const c = cfg.ccd;
  const orf   = (orifice  - c.orfSub)   / c.orfDiv;
  const as    = (airspeed - c.asSub)    / c.asDiv;
  const press = (pressure - c.pressSub) / c.pressDiv;
  const ang   = (angle    - c.angSub)   / c.angDiv;
  return { orf, as, press, ang };
}

function evaluateResponseDroplet(coeffs, coded) {
  const { orf, as, press, ang } = coded;
  const [
    B, C, D, E, F,
    G, H, I, J, K,
    L, M, N, O, P
  ] = coeffs;

  return (
    B +
    C * orf + D * as + E * press + F * ang +
    G * orf * as +
    H * orf * press +
    I * as * press +
    J * orf * ang +
    K * as * ang +
    L * press * ang +
    M * orf * orf +
    N * as * as +
    O * press * press +
    P * ang * ang
  );
}

function classifyDVToCode(dv, thresholds) {
  const [vf_f, f_m, m_c, c_vc, vc_xc, xc_uc] = thresholds;

  if (dv >= xc_uc) return 7;
  if (dv >= vc_xc) return 6;
  if (dv >= c_vc)  return 5;
  if (dv >= m_c)   return 4;
  if (dv >= f_m)   return 3;
  if (dv >= vf_f)  return 2;
  if (dv >= 0)     return 1;
  return null;
}

function classifyDSC(dv01, dv05, dv09) {
  const code01 = classifyDVToCode(dv01, DV_THRESHOLDS.dv01);
  const code05 = classifyDVToCode(dv05, DV_THRESHOLDS.dv05);
  const code09 = classifyDVToCode(dv09, DV_THRESHOLDS.dv09);

  const label01 = code01 ? (DSC_LABELS[code01] || "UNKNOWN") : null;
  const label05 = code05 ? (DSC_LABELS[code05] || "UNKNOWN") : null;
  const label09 = code09 ? (DSC_LABELS[code09] || "UNKNOWN") : null;

  if (code01 == null || code05 == null) {
    return {
      overallCode: null,
      overallLabel: "OUT OF RANGE",
      code01, code05, code09,
      label01, label05, label09
    };
  }

  const overallCode = Math.min(code01, code05);
  const overallLabel = DSC_LABELS[overallCode] || "UNKNOWN";

  return {
    overallCode,
    overallLabel,
    code01, code05, code09,
    label01, label05, label09
  };
}
// Decide which nozzle family (if any) should filter droplet suggestions
function getDropletFamilyFilter() {
  const modeSel    = getEl("family");
  const sizingMode = (modeSel && modeSel.value === "multi") ? "multi" : "single";

  if (sizingMode === "single") {
    // Global override in single-nozzle mode; empty means "Best Fit (Any Family)"
    return globalFamilyOverride || "";
  }

  // Multi-nozzle mode: if exactly one unique per-row override exists, use it.
  const vals = Object.values(rowFamilyOverrides || {}).filter(v => v);
  if (!vals.length) return "";
  const unique = Array.from(new Set(vals));
  return unique.length === 1 ? unique[0] : "";
}

// Returns null, or { globalSet: Set<string>, perFamily: { [famKey]: Set<string> } }
function getDropletOrificeFilter() {
  const state = lastSizingState;
  if (!state) return null;

  const allowed = new Set();

  if (state.sizingMode === "single") {
    if (state.nozzleSize != null) {
      allowed.add(String(state.nozzleSize));
    }
  } else if (state.sizingMode === "multi" && state.rowSolutions) {
    Object.values(state.rowSolutions).forEach(sol => {
      if (sol && sol.size != null) {
        allowed.add(String(sol.size));
      }
    });
  }

  // If nothing got added, don't restrict
  return allowed.size ? allowed : null;
}


/**
 * Black-box droplet evaluation for SwathPro.
 * family: droplet family key (must exist in DROPLET_DB)
 * orifice: numeric tip size (e.g. 4, 6, 20)
 * pressure: nozzle pressure (psi) – NOT gauge
 * airspeed: mph
 * angle: nozzle body angle (deg); we’ll use 0° or family default
 */
function evaluateNozzleDroplet(family, orifice, pressure, airspeed, angle) {
  const cfg = DROPLET_DB[family];
  if (!cfg) return null;

  const coded = codeVariablesDroplet(cfg, orifice, airspeed, pressure, angle);

  // Core DV predictions
  const dv01 = evaluateResponseDroplet(cfg.dv01, coded);
  const dv05 = evaluateResponseDroplet(cfg.dv05, coded);
  const dv09 = evaluateResponseDroplet(cfg.dv09, coded);

  // Driftable fines (%<100 µm, %<200 µm)
  let v100 = NaN, v200 = NaN;
  const less100 = cfg.less100 || cfg.vlt100;
  const less200 = cfg.less200 || cfg.vlt200;
  if (less100 && less200) {
    v100 = evaluateResponseDroplet(less100, coded);
    v200 = evaluateResponseDroplet(less200, coded);
  }

  // USDA droplet size category
  const dsc = classifyDSC(dv01, dv05, dv09);

  return {
    dv01,
    dv05,
    dv09,
    v100,
    v200,
    dsc
  };
}


// Map SwathPro nozzle family → droplet family key.
// For now names match; this is here for future alias handling.
function mapFamilyToDropletKey(family) {
  return DROPLET_DB[family] ? family : null;
}

function populateDropletAngles() {
  const angleSel = getEl("dropletAngle");
  const famSel   = getEl("family");
  if (!angleSel || !famSel) return;

  const fam = famSel.value;
  const dropletKey = mapFamilyToDropletKey(fam);
  angleSel.innerHTML = "";

  if (!dropletKey || !DROPLET_DB[dropletKey] || !Array.isArray(DROPLET_DB[dropletKey].angles)) {
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "Auto";
    angleSel.appendChild(opt);
    return;
  }

  const cfgAngles = DROPLET_DB[dropletKey].angles;
  const optAuto = document.createElement("option");
  optAuto.value = "";
  optAuto.textContent = "Auto";
  angleSel.appendChild(optAuto);

  cfgAngles.forEach(a => {
    const opt = document.createElement("option");
    opt.value = String(a);
    opt.textContent = `${a}°`;
    angleSel.appendChild(opt);
  });
}

function getDropletSearchPressure() {
  const useGaugeEl = getEl("useGaugePsi");
  const headerEl   = getEl("dropletPressureHeader");

  const useGauge = !!(useGaugeEl && useGaugeEl.checked);

  if (headerEl) {
    headerEl.textContent = useGauge ? "Gauge PSI" : "Nozzle PSI";
  }

  // Use the worst-load row (GPA * swath) from the last sizing state
  const state = lastSizingState;
  if (!state || !state.rateRows || !state.rateRows.length) return 0;

  let worstRow  = state.rateRows[0];
  let worstLoad = worstRow.gpa * worstRow.sw;

  for (let i = 1; i < state.rateRows.length; i++) {
    const r    = state.rateRows[i];
    const load = r.gpa * r.sw;
    if (load > worstLoad) {
      worstLoad = load;
      worstRow  = r;
    }
  }

  // For now we always return Gauge PSI; per-nozzle nozzle PSI is computed
  // inside findNozzlesByDSC when needed.
  const gaugePsi = worstRow.psi || 0;
  return gaugePsi;
}

function buildDropletResultsFromSizingState(airspeed) {
  const state = lastSizingState;
  if (!state || !state.rateRows || !state.rateRows.length || !airspeed) return [];

  const useGaugeEl = getEl("useGaugePsi");
  const useGauge   = !!(useGaugeEl && useGaugeEl.checked);

  const rows    = state.rateRows;
  const results = [];

  // We now drive droplet results from:
  //  - the orifice size the sizing engine chose (single or multi)
  //  - all droplet families that support that orifice
  const dropletFamilies = Object.keys(DROPLET_DB);
    // Optional global family filter (single-nozzle mode uses this)
  const famFilterGlobal = getDropletFamilyFilter();

  rows.forEach(row => {
    const gaugePsi = row.psi || 0;
    if (!gaugePsi) return;

    // Per-row droplet target from rate table (drop1/drop2/drop3)
    // row.dsc is already uppercased in getRateRows()
    const rowDsc = (row.dsc || "").trim();

    let rowEffectiveTarget;
    if (!rowDsc) {
      // Blank / "None" → sentinel meaning "return nothing for this row"
      rowEffectiveTarget = "__NONE__";
    } else if (rowDsc === "ALL") {
      // "All" → no DSC filter
      rowEffectiveTarget = "";
    } else {
      // Specific DSC (MEDIUM, COARSE, etc.)
      rowEffectiveTarget = rowDsc;
    }

    const beforeCount = results.length;
    // Determine which orifice(s) apply to this rate row
    const orificesForRow = [];

    if (state.sizingMode === "single") {
      if (state.nozzleSize != null) {
        orificesForRow.push(parseFloat(state.nozzleSize));
      }
    } else if (state.sizingMode === "multi" && state.rowSolutions && state.rowSolutions[row.idx]) {
      const sol = state.rowSolutions[row.idx];
      if (sol && sol.size != null) {
        orificesForRow.push(parseFloat(sol.size));
      }
    }

    if (!orificesForRow.length) return;
	
	    // Family filter for this row:
    //  - single mode: global override (Best Fit = all families)
    //  - multi mode: per-row override if present (Best Fit = all families)
    let famFilterForRow = "";
    if (state.sizingMode === "single") {
      famFilterForRow = famFilterGlobal || "";
    } else if (state.sizingMode === "multi") {
      famFilterForRow = (rowFamilyOverrides && rowFamilyOverrides[row.idx]) || "";
    }

    orificesForRow.forEach(orifice => {
      dropletFamilies.forEach(famKey => {
        const cfgDroplet = DROPLET_DB[famKey];
        if (!cfgDroplet) return;
		
		        // Family filter: when a specific nozzle family is selected for this row,
        // only show droplet results for that family.
        if (famFilterForRow && famKey !== famFilterForRow) return;

        // Need Flow_DB data for Cv and nozzle pressure physics
        const famFlow = FLOW_DB[famKey];
        if (!famFlow) return;

        const orificeKey = String(orifice);

        // Only consider families that actually have this orifice:
        //  - if DROPLET_DB.orifices exists, use that set
        //  - otherwise, fall back to whatever exists in FLOW_DB
        let hasDropletOrifice = true;
        if (Array.isArray(cfgDroplet.orifices)) {
          hasDropletOrifice = cfgDroplet.orifices.includes(orifice);
        } else {
          hasDropletOrifice = !!famFlow[orificeKey];
        }
        if (!hasDropletOrifice) return;

        const flowCfg = famFlow[orificeKey];
        if (!flowCfg || !flowCfg.c) return;

        const tipCv = tipCvFromRating(flowCfg.c);
        if (!tipCv) return;


        const gaugePressure  = gaugePsi;
        const nozzlePressure = nozzlePressureFromGauge(gaugePressure, tipCv);
        const tipPressure    = useGauge ? gaugePressure : nozzlePressure;

        // Angles to evaluate – "Auto": all angles for family, or a default set.
        let anglesToUse = [];
        if (Array.isArray(cfgDroplet.angles) && cfgDroplet.angles.length) {
          anglesToUse = cfgDroplet.angles.slice();
        } else {
          // Fallback: evaluate a standard set of body angles
          anglesToUse = [0, 20, 40, 60, 80];
        }


        anglesToUse.forEach(angle => {
          const data = evaluateNozzleDroplet(famKey, orifice, tipPressure, airspeed, angle);
          if (!data || !data.dsc || !data.dsc.overallLabel) return;

          const labelNorm = data.dsc.overallLabel.toUpperCase();

          // Per-row DSC filter:
          // rowEffectiveTarget = "" → no filter (None/All)
          // otherwise              → must match DSC
          // NONE → return nothing for this row
if (rowEffectiveTarget === "__NONE__") return;

// Specific DSC → must match
if (rowEffectiveTarget && labelNorm !== rowEffectiveTarget) return;

        results.push({
          family:     famKey,
          angle,
          orifice,
          pressure:   tipPressure,
          gaugePsi:   gaugePressure,
          nozzlePsi:  nozzlePressure,
          dv05:       data.dv05,
          v100:       data.v100,
          v200:       data.v200,
          dscLabel:   data.dsc.overallLabel,
          rateIdx:    row.idx
        });
      });
    });
  });

    // If a specific DSC was requested for this rate and we found no matches,
    // add a placeholder row so the user sees that the search ran.
    if (results.length === beforeCount &&
        rowEffectiveTarget &&
        rowEffectiveTarget !== "__NONE__") {

      results.push({
        family:    "",
        angle:     "",
        orifice:   "",
        pressure:  NaN,
        gaugePsi:  NaN,
        nozzlePsi: NaN,
        dv05:      NaN,
        v100:      NaN,
        v200:      NaN,
        dscLabel:  `No ${rowEffectiveTarget} Found`,
        rateIdx:   row.idx
      });
    }
  });

  return results;
}








function refreshDropletSuggestionsFromState(){
  const dropletCard = getEl("dropletSuggestions");
  const body        = getEl("dropletSuggestionsBody");

  if (!dropletCard || !body) return;

  const vHi = parseFloat(getEl("vHi")?.value || "0");
  if (!vHi || !lastSizingState || !lastSizingState.rateRows || !lastSizingState.rateRows.length) {
    dropletCard.style.display = "none";
    body.innerHTML = "";
    return;
  }

  // updates Gauge/Nozzle header
  getDropletSearchPressure();

  // Now driven entirely by per-row droplet category (drop1/drop2/drop3)
  const results = buildDropletResultsFromSizingState(vHi);

  if (!results || !results.length) {
    dropletCard.style.display = "none";
    body.innerHTML = "";
    return;
  }

  renderDropletSuggestions(results);
}










// Supported patterns
const PATTERNS = [
  { id:"all",      label:"All nozzles on",     factor:1.0 },
  { id:"1on1off",  label:"1 on / 1 off",       factor:0.5 },
  { id:"1on2off",  label:"1 on / 2 off",       factor:1/3 }
];

// User overrides: rate index (1–3) → pattern id
const patternOverrides = {};
// User overrides: rate index (1–3) → nozzle family (for future multi-nozzle)
const rowFamilyOverrides = {};
// Global family override in single-nozzle mode
let globalFamilyOverride = "";


// --- Helpers ---
function clamp(v, lo, hi){
  if (isNaN(v)) return lo;
  return Math.min(hi, Math.max(lo, v));
}

function getEl(id){ return document.getElementById(id); }

// --- Aircraft / T-Boom / nozzle count ---
function getTotalNozzles(){
  const aircraft = getEl("aircraft").value;
  const base     = NOZZLE_BASE[aircraft] || 0;

  const tInput   = getEl("tBoomCount");
  let tCount     = parseInt(tInput.value || "0", 10);
  tCount         = clamp(tCount, 0, 6);
  tInput.value   = tCount;

  const total = base + tCount;
  getEl("nozzleCountDisplay").textContent = total || "—";
  return total;
}

// --- Rate blocks ---
// --- Rate blocks ---
function getRateRows(){
  const rows = [];
  for (let i = 1; i <= 3; i++) {
    const gpa = parseFloat(getEl("gpa" + i).value || "0");
    const sw  = parseFloat(getEl("swath" + i).value || "0");
    const psi = parseFloat(getEl("psi"  + i)?.value || "0");

    // USDA droplet requirement for this rate (VERY FINE, FINE, MEDIUM, etc.)
    const rawDrop = getEl("drop" + i) ? getEl("drop" + i).value : "";
    const dsc = rawDrop ? rawDrop.trim().toUpperCase() : "";

    // row is active only if it has rate, swath, and gauge PSI
    if (gpa > 0 && sw > 0 && psi > 0) {
      rows.push({
        idx: i,
        gpa,
        sw,
        psi,
        dsc
      });
    }
  }
  return rows;
}



// Total GPM for a given rate/swath at speed
function totalGpm(gpa, swathFt, mph){
  return (gpa * swathFt * mph) / GPAK;
}

// --- Family / sizing mode ---
function populateFamilies(){
  const famSel = getEl("family");
  if (!famSel) return;

  famSel.innerHTML = "";

  // Single-nozzle best fit
  const optSingle = document.createElement("option");
  optSingle.value = "single";
  optSingle.textContent = "Single Nozzle – Best Fit";
  optSingle.selected = true;
  famSel.appendChild(optSingle);

  // Multi-nozzle best fit (behavior same as single for now; just a mode flag)
  const optMulti = document.createElement("option");
  optMulti.value = "multi";
  optMulti.textContent = "Multi-Nozzle – Best Fit";
  famSel.appendChild(optMulti);
}




// Choose nozzle size from FLOW_DB based on the worst-case rate at max speed.
// familyOverride: "" = Best Fit across all families, otherwise restrict to that family.
// Uses valve/check Cv + tip Cv for nozzle PSI and empirical A/B flow for q100.
// This is the "golden" single-nozzle selector: worst-case rate, all nozzles on.
function pickNozzleSize(familyOverride, totalNozzles, rateRows){
  const vHi = parseFloat(getEl("vHi").value || "0");
  if (!vHi || !rateRows.length || !totalNozzles) return null;

  // Find worst-case row by load (GPA * swath)
  let worstRow  = rateRows[0];
  let worstLoad = worstRow.gpa * worstRow.sw;

  for (let i = 1; i < rateRows.length; i++) {
    const r    = rateRows[i];
    const load = r.gpa * r.sw;
    if (load > worstLoad) {
      worstLoad = load;
      worstRow  = r;
    }
  }

  const gaugePsi = worstRow.psi || 0;
  if (!gaugePsi) return null;

  const famKeys = familyOverride
    ? [familyOverride]
    : Object.keys(FLOW_DB);

  let best = null;

  famKeys.forEach(famKey => {
    const famData = FLOW_DB[famKey];
    if (!famData) return;

    Object.keys(famData).forEach(sizeKey => {
      const coeff = famData[sizeKey];
      if (!coeff) return;

      const nozGpm40 = coeff.c;   // GPM @ 40 psi rating
      if (!nozGpm40) return;

      // Tip Cv from rating and nozzle pressure from gauge Psi
      const tipCv = tipCvFromRating(nozGpm40);
      if (!tipCv) return;

      const Pn = nozzlePressureFromGauge(gaugePsi, tipCv);
      if (!Pn) return;

      // Full-flow per nozzle at Pn using empirical aerial curve (A/B)
      const q100 = nozzleFlowEmpirical(Pn, coeff);
      if (!q100) return;

      // Worst-case total flow at max speed
      const totalFlowWorst = totalGpm(worstRow.gpa, worstRow.sw, vHi);
      if (!totalFlowWorst || totalFlowWorst <= 0) return;

      // All nozzles on for sizing
      const qPerNozzleReq = totalFlowWorst / totalNozzles;
      const dcReq         = qPerNozzleReq / q100;
      const dcPct         = dcReq * 100;

      if (!isFinite(dcPct) || dcPct <= 0) return;
      // Only reject extremely low duty; allow >100% so single-nozzle can still size
      if (dcPct < 30) return;

      const distToOpt = Math.abs(dcPct - DC_OPT);

      const candidate = {
        family:    famKey,
        size:      sizeKey,
        q100,
        nozzlePsi: Pn,
        dcPct,
        distToOpt,
        gaugePsi   // store for recommendation text
      };

      if (!best || distToOpt < best.distToOpt) {
        best = candidate;
      }
    });
  });

  return best;
}

// Per-row nozzle sizing for Multi-Nozzle – Best Fit.
// familyOverride: "" = Best Fit across all families, otherwise restrict to that family.
// Sizes for a single rate row at max speed, using the active-nozzle count
// implied by the row's pattern (if any). "opt" still sizes assuming all nozzles on.
function pickNozzleSizeForRow(familyOverride, totalNozzles, row){
  const vHi = parseFloat(getEl("vHi").value || "0");
  if (!vHi || !row || !totalNozzles) return null;

  const totalFlow = totalGpm(row.gpa, row.sw, vHi);
  if (!totalFlow || totalFlow <= 0) return null;

  const gaugePsi = row.psi || 0;
  if (!gaugePsi) return null;

  // NEW: pattern-aware sizing – use this row's pattern override if present
  let patternFactor = 1.0;
  const overrideId = patternOverrides[row.idx];
  if (overrideId && overrideId !== "opt") {
    const p = PATTERNS.find(p => p.id === overrideId);
    if (p) patternFactor = p.factor;
  }

  const activeNozzles = Math.max(1, Math.round(totalNozzles * patternFactor));

  const famKeys = familyOverride
    ? [familyOverride]
    : Object.keys(FLOW_DB);

  let best = null;

  famKeys.forEach(famKey => {
    const famData = FLOW_DB[famKey];
    if (!famData) return;

    Object.keys(famData).forEach(sizeKey => {
      const coeff = famData[sizeKey];
      if (!coeff) return;

      const nozGpm40 = coeff.c;
      if (!nozGpm40) return;

      const tipCv = tipCvFromRating(nozGpm40);
      if (!tipCv) return;

      const Pn = nozzlePressureFromGauge(gaugePsi, tipCv);
      if (!Pn) return;

      const q100 = nozzleFlowEmpirical(Pn, coeff);
      if (!q100) return;

      // Size the orifice for the PATTERN's active nozzle count
      const qPerNozzleReq = totalFlow / activeNozzles;
      const dcReq         = qPerNozzleReq / q100;
      const dcPct         = dcReq * 100;

      if (!isFinite(dcPct) || dcPct <= 0) return;
      // Only reject extremely low duty; allow >100% so single-nozzle can still size
      if (dcPct > 100 || dcPct < 30) return;

      const distToOpt = Math.abs(dcPct - DC_OPT);

      const candidate = {
        family:    famKey,
        size:      sizeKey,
        q100,
        nozzlePsi: Pn,
        dcPct,
        distToOpt
      };

      if (!best || distToOpt < best.distToOpt) {
        best = candidate;
      }
    });
  });

  return best;
}










// --- Duty classification for pill color ---
function dutyClass(dcPct){
  let cls = "p-green";
  if (dcPct < DC_GOOD_LO || dcPct > DC_GOOD_HI){
    cls = "p-yellow";
  }
  if (dcPct <= 40 || dcPct > 100){
    cls = "p-red";
  }
  return cls;
}

// --- Choose pattern for a given row ---
function computePatternForRow(row, state, forcedPatternId){
  const isMulti = state && state.sizingMode === "multi";

  let q100 = null;

  if (isMulti && state.rowSolutions && state.rowSolutions[row.idx] && state.rowSolutions[row.idx].q100){
    // multi-nozzle: q100 already sized at this row's gauge PSI
    q100 = state.rowSolutions[row.idx].q100;
  } else if (!isMulti && state.family && state.nozzleSize) {
    // single-nozzle: compute q100 at this row's gauge PSI
    const famData = FLOW_DB[state.family];
    const coeff   = famData && famData[state.nozzleSize];
    if (coeff) {
      const nozGpm40 = coeff.c;
      const tipCv    = tipCvFromRating(nozGpm40);
      const gaugePsi = row.psi || 0;
      const Pn       = (tipCv && gaugePsi) ? nozzlePressureFromGauge(gaugePsi, tipCv) : 0;
      if (Pn) {
        q100 = nozzleFlowEmpirical(Pn, coeff);
      }
    }
  }

  if (!q100) {
    // fall back to legacy behavior if anything above fails
    q100 = state.q100;
  }
  const totalNozzles = state.totalNozzles;
  const vHi          = state.vHi;

  if (!q100 || !totalNozzles || !vHi) return null;

  const totalFlow = totalGpm(row.gpa, row.sw, vHi);
  if (!totalFlow || totalFlow <= 0) return null;

  // ---- SPECIAL PATTERN: optimize active nozzles ----
  if (forcedPatternId === "opt") {
    const dcTarget = DC_OPT / 100; // 0.75 target duty
    const ideal = totalFlow / (q100 * dcTarget);

    let activeNozzles = clamp(Math.round(ideal), 1, totalNozzles);
    const qPerNozzleReq = totalFlow / activeNozzles;
    const dcReq = qPerNozzleReq / q100;

    if (!isFinite(dcReq) || dcReq <= 0) return null;  // only reject broken math

    const dcPct = dcReq * 100;

    // Always return result, even if >105% duty
    return {
      id: "opt",
      label: "Optimize active nozzles",
      activeNozzles,
      qPerNozzleReq,
      dcPct,
      distToOpt: Math.abs(dcPct - DC_OPT)
    };
  }

  // ---- FIXED PATTERN LOGIC ----
  let candidates = PATTERNS;

  // Manual override of a fixed pattern
  if (forcedPatternId && forcedPatternId !== "opt") {
    const p = PATTERNS.find(p => p.id === forcedPatternId);
    if (!p) return null;
    candidates = [p];
  }

  let bestUnder105 = null;
  let bestOver105  = null;

  candidates.forEach(p => {
    const activeNozzles = Math.max(1, Math.round(totalNozzles * p.factor));
    const qPerNozzleReq = totalFlow / activeNozzles;
    const dcReq = qPerNozzleReq / q100;

    if (!isFinite(dcReq) || dcReq <= 0) return;

    const dcPct = dcReq * 100;
    const distToOpt = Math.abs(dcPct - DC_OPT);

    const candidate = {
      id: p.id,
      label: p.label,
      activeNozzles,
      qPerNozzleReq,
      dcPct,
      distToOpt
    };

    if (!forcedPatternId) {
      // AUTO: prefer <=105%, but keep >105% as fallback instead of zeroing
      if (dcPct <= 105) {
        if (!bestUnder105 || distToOpt < bestUnder105.distToOpt) {
          bestUnder105 = candidate;
        }
      } else {
        if (!bestOver105 || distToOpt < bestOver105.distToOpt) {
          bestOver105 = candidate;
        }
      }
    } else {
      // Manual fixed pattern (ALL, 1on1off, 1on2off)
      if (!bestUnder105 || distToOpt < bestUnder105.distToOpt) {
        bestUnder105 = candidate;
      }
    }
  });

  if (!forcedPatternId) {
    return bestUnder105 || bestOver105;
  }
  return bestUnder105;
}


// --- Single-nozzle viability warning ---
// Checks:
//  - Max duty with ALL nozzles ON must be <= 100%
//  - Min duty with 1-on-2-off must be >= 60%
function updateSingleNozzleWarning(state){
  const el = getEl("singleWarning");
  if (!el) return;

  // Default: hide warning
  el.style.display = "none";
  el.textContent = "";

  if (!state || state.sizingMode !== "single" || !state.rateRows || !state.rateRows.length) {
    return;
  }

  // Need a valid family + size to evaluate
  if (!state.family || !state.nozzleSize) return;

  let maxAll = -Infinity;
  let min1on2 = Infinity;

  state.rateRows.forEach(row => {
    const pAll = computePatternForRow(row, state, "all");
    const p12 = computePatternForRow(row, state, "1on2off");

    if (pAll && isFinite(pAll.dcPct)) {
      if (pAll.dcPct > maxAll) maxAll = pAll.dcPct;
    }
    if (p12 && isFinite(p12.dcPct)) {
      if (p12.dcPct < min1on2) min1on2 = p12.dcPct;
    }
  });

  if (!isFinite(maxAll) && !isFinite(min1on2)) return;

  const tooHigh = isFinite(maxAll) && maxAll > 100;
  const tooLow  = isFinite(min1on2) && min1on2 < 60;

  if (!tooHigh && !tooLow) return;

  let msg = "Warning: Single-nozzle mode may not cover your full rate range. ";

if (tooHigh && tooLow) {
  msg += `Single-nozzle mode cannot meet both high and low rate requirements.`;
} else if (tooHigh) {
  msg += `Single-nozzle mode exceeds duty limits at higher rates.`;
} else if (tooLow) {
  msg += `Single-nozzle mode falls below duty limits at lower rates.`;
}


  msg += " Consider adjusting rate, swath, pressure, or using Multi-Nozzle – Best Fit.";

  el.textContent = msg;
  el.style.display = "block";
}

// --- Build table ---
function buildTable(state){
  const tableCard = getEl("tableCard");
  const tbody     = getEl("tbody");
  tbody.innerHTML = "";

  if (!state || !state.rateRows.length){
    if (tableCard) tableCard.style.display = "none";
    return;
  }

  if (tableCard) tableCard.style.display = "block";

  const fams = Object.keys(FLOW_DB);

  state.rateRows.forEach(row => {
    const overrideId = patternOverrides[row.idx];

    const computed = computePatternForRow(row, state, overrideId);

    const fallbackId = overrideId || "all";
    const fallbackPattern =
      PATTERNS.find(p => p.id === fallbackId) || PATTERNS[0];

    // Never drop the row; if computePatternForRow fails, show N/A instead of 0%
    const choice = computed || {
      id: fallbackId,
      label: fallbackPattern.label,
      activeNozzles: state.totalNozzles || 0,
      qPerNozzleReq: NaN,
      dcPct: NaN,
      distToOpt: NaN
    };



    const tr = document.createElement("tr");
	
	    // Per-row sizing solution in multi-nozzle mode (if available)
    const rowSol = (state.sizingMode === "multi" &&
                    state.rowSolutions &&
                    state.rowSolutions[row.idx])
      ? state.rowSolutions[row.idx]
      : null;


    // Target GPA
    let td = document.createElement("td");
    td.textContent = row.gpa.toFixed(1);
    tr.appendChild(td);

    // Swath
    td = document.createElement("td");
    td.textContent = row.sw.toFixed(0);
    tr.appendChild(td);

    // Nozzle family (per-row dropdown)
    td = document.createElement("td");
    const famSel = document.createElement("select");
    famSel.className = "family-select";
    famSel.dataset.rateIdx = String(row.idx);

// Selected family:
//  - single mode: only show global override; otherwise stay on "Best Fit (Any Family)"
//  - multi mode: per-row override, falling back to auto-sized family
let selectedFam = "";
if (state.sizingMode === "single") {
  selectedFam = globalFamilyOverride || "";
} else {
  selectedFam = rowFamilyOverrides[row.idx] || "";
}

    // "Best Fit (Any Family)" option
    const optAny = document.createElement("option");
    optAny.value = "";
    optAny.textContent = "Best Fit (Any Family)";
    if (!selectedFam) optAny.selected = true;
    famSel.appendChild(optAny);

    // Specific families
    fams.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      if (name === selectedFam) opt.selected = true;
      famSel.appendChild(opt);
    });

    td.appendChild(famSel);
    tr.appendChild(td);

    // Orifice (selected tip size)
    td = document.createElement("td");
    const orifice = rowSol ? rowSol.size : (state.nozzleSize || "—");
    td.textContent = orifice || "—";
    tr.appendChild(td);


    // Pattern (dropdown)
    td = document.createElement("td");
    const sel = document.createElement("select");
    sel.className = "pattern-select";
    sel.dataset.rateIdx = String(row.idx);

    PATTERNS.forEach(p => {
      const opt = document.createElement("option");
      opt.value = p.id;
      opt.textContent = p.label;
      if (p.id === choice.id) opt.selected = true;
      sel.appendChild(opt);
    });

    const optAuto = document.createElement("option");
    optAuto.value = "opt";
    optAuto.textContent = "Optimize active nozzles";
    if (choice.id === "opt") optAuto.selected = true;
    sel.appendChild(optAuto);

    td.appendChild(sel);
    tr.appendChild(td);

    // Active nozzles
    td = document.createElement("td");
    td.textContent = choice.activeNozzles.toString();
    tr.appendChild(td);

    // Duty cycle (pill)
    td = document.createElement("td");
    const pill = document.createElement("span");

    if (!isFinite(choice.dcPct)) {
      pill.className = "pill p-red";
      pill.textContent = "N/A";
    } else {
      pill.className = "pill " + dutyClass(choice.dcPct);
      pill.textContent = choice.dcPct.toFixed(0) + "%";
    }

    td.appendChild(pill);
    tr.appendChild(td);


// Nozzle PSI
td = document.createElement("td");
let nozzlePsi = null;

if (rowSol && rowSol.nozzlePsi != null) {
  // multi-nozzle: already per-rate
  nozzlePsi = rowSol.nozzlePsi;
} else if (state.sizingMode === "single" && state.family && state.nozzleSize) {
  // single-nozzle: recompute nozzle psi for this row from gauge psi
  const famData = FLOW_DB[state.family];
  const coeff   = famData && famData[state.nozzleSize];
  if (coeff) {
    const nozGpm40 = coeff.c;
    const tipCv    = tipCvFromRating(nozGpm40);
    const gaugePsi = row.psi || 0;
    nozzlePsi      = (tipCv && gaugePsi) ? nozzlePressureFromGauge(gaugePsi, tipCv) : null;
  }
}

// fallback if we somehow still don't have it
if (nozzlePsi == null && state.nozzlePsi != null) {
  nozzlePsi = state.nozzlePsi;
}

td.textContent = nozzlePsi != null ? nozzlePsi.toFixed(0) : "—";
tr.appendChild(td);



    tbody.appendChild(tr);
  });
}


// --- Recommendation summary ---
function updateRecommendation(state, nozzle){
  const recCard  = getEl("recCard");
  const recText  = getEl("recText");
  const recNotes = getEl("recNotes");

  // Panel is gone in new layout – bail out quietly
  if (!recCard || !recText || !recNotes) return;

  if (!state || !nozzle){
    recCard.style.display = "none";
    recText.textContent   = "";
    recNotes.textContent  = "";
    return;
  }

  recCard.style.display = "block";

const fam  = state.family;
const psi  = state.gaugePsi != null ? state.gaugePsi : 0;
const size = nozzle.size;
const aircraft = getEl("aircraft").value;
const vHi      = state.vHi;

recText.textContent = psi
  ? `Model nozzle at ${psi} psi on ${aircraft}, sized so worst-case rate runs ~${DC_OPT}% duty.`
  : `Model nozzle on ${aircraft}, sized so worst-case rate runs ~${DC_OPT}% duty.`;


  recNotes.textContent =
    `Nozzle sized on worst-case rate at ${vHi} mph, targeting ~${DC_OPT}% duty. ` +
    `Patterns above show duty for each rate using the same nozzle.`;
}


// --- Render USDA droplet suggestions mini-table ---
function renderDropletSuggestions(results) {
  const wrap = getEl("dropletSuggestions");
  const body = getEl("dropletSuggestionsBody");
  if (!wrap || !body) return;

  body.innerHTML = "";

  if (!results || !results.length) {
    wrap.style.display = "none";
    return;
  }

  results.forEach((r, idx) => {
    const tr = document.createElement("tr");
    // Rate-based coloring: R1, R2, R3 share colors
const rowClass = r.rateIdx ? `dsc-rate-${r.rateIdx}` : "dsc-rate-none";
tr.classList.add("dsc-colored", rowClass);
    tr.innerHTML = `
      <td>${r.family}</td>
      <td style="text-align:left;">${r.rateIdx ? "R" + r.rateIdx : ""}</td>
      <td style="text-align:right;">${Number.isFinite(r.pressure) ? r.pressure.toFixed(0) : "–"}</td>
      <td style="text-align:right;">${r.angle}&deg;</td>
      <td style="text-align:right;">${r.orifice}</td>
      <td style="text-align:right;">${Number.isFinite(r.dv05) ? r.dv05.toFixed(0) : "–"}</td>
      <td style="text-align:right;">${Number.isFinite(r.v100) ? r.v100.toFixed(1) + "%" : "–"}</td>
      <td style="text-align:right;">${Number.isFinite(r.v200) ? r.v200.toFixed(1) + "%" : "–"}</td>
      <td>${r.dscLabel}</td>
    `;
    body.appendChild(tr);
  });

  wrap.style.display = "block";
}




// --- Main calc ---
function doCalc(){
  const totalNozzles = getTotalNozzles();

  const vInput = getEl("vHi");
  let vHi = parseFloat(vInput?.value || "0");
  vHi = clamp(vHi, 0, 220);        // hard cap at 220 mph
  if (vInput) vInput.value = vHi || "";  // write clamped value back to the box

  const rows = getRateRows();

  const modeSel    = getEl("family");
  const sizingMode = (modeSel && modeSel.value === "multi") ? "multi" : "single";

  const prevState = lastSizingState || null;
  const prevMode  = prevState ? prevState.sizingMode : null;

  // NEW: if sizing mode changed (single ↔ multi), clear pattern overrides
  if (prevMode && prevMode !== sizingMode) {
    Object.keys(patternOverrides).forEach(k => delete patternOverrides[k]);
  }

  if (!totalNozzles || !vHi || !rows.length){
    updateRecommendation(null, null);
    updateDropletSummary(null, null);
    lastSizingState = null;
    lastSizedNozzle = null;
    updateSingleNozzleWarning(null);
    buildTable(null);
    return;
  }



  let nozzle = null;

  const state = {
    vHi,
    totalNozzles,
    rateRows:     rows,
    q100:         null,
    nozzleSize:   null,
    nozzlePsi:    null,
    gaugePsi:     null,
    family:       "",
    sizingMode,
    rowSolutions: null
  };

if (sizingMode === "single") {
  const famOverride = globalFamilyOverride || "";
  nozzle = pickNozzleSize(famOverride, totalNozzles, rows);

  // NEW: if nozzle size changed vs previous single-nozzle run, reset patterns
  if (nozzle) {
    const prevSize =
      (lastSizingState && lastSizingState.sizingMode === "single")
        ? lastSizingState.nozzleSize
        : null;

    if (prevSize != null && nozzle.size !== prevSize) {
      Object.keys(patternOverrides).forEach(k => delete patternOverrides[k]);
    }
  }

  if (nozzle){
    state.family     = nozzle.family;
    state.q100       = nozzle.q100;     // q100 at worst-row PSI (used as fallback)
    state.nozzleSize = nozzle.size;
    state.nozzlePsi  = nozzle.nozzlePsi;
    state.gaugePsi   = nozzle.gaugePsi || null;
  }

} else {
    const rowSolutions = {};

    rows.forEach(row => {
      const famOverride = rowFamilyOverrides[row.idx] || "";
      const sol = pickNozzleSizeForRow(famOverride, totalNozzles, row);
      if (sol) {
        rowSolutions[row.idx] = sol;
      }
    });

    state.rowSolutions = rowSolutions;
  }
  
    if (sizingMode === "single") {
    if (!nozzle || !state.q100){
      buildTable(null);
      return;
    }

    // NEW: if the selected orifice changed in single-nozzle mode,
    // wipe pattern overrides so patterns are re-picked for the new tip size.
    const prevSize =
      (prevState && prevState.sizingMode === "single")
        ? prevState.nozzleSize
        : null;

    if (prevSize != null &&
        state.nozzleSize != null &&
        state.nozzleSize !== prevSize) {
      Object.keys(patternOverrides).forEach(k => delete patternOverrides[k]);
    }

  } else {
    if (!state.rowSolutions || !Object.keys(state.rowSolutions).length){
      buildTable(null);
      return;
    }
  }

  updateRecommendation(state, nozzle);
  lastSizingState = state;
  updateSingleNozzleWarning(state);


  if (sizingMode === "single") {
    if (!nozzle || !state.q100){
      buildTable(null);
      return;
    }
  } else {
    if (!state.rowSolutions || !Object.keys(state.rowSolutions).length){
      buildTable(null);
      return;
    }
  }

  buildTable(state);
  refreshDropletSuggestionsFromState();
}




// --- Wire events ---
document.addEventListener("DOMContentLoaded", () => {
  populateFamilies();
  populateDropletAngles();
  getTotalNozzles();
  doCalc();
  refreshDropletSuggestionsFromState();

  // aircraft / T-Boom / speed
  getEl("aircraft").addEventListener("change", () => { getTotalNozzles(); doCalc(); refreshDropletSuggestionsFromState(); });
  getEl("tBoomCount").addEventListener("input", () => { getTotalNozzles(); doCalc(); refreshDropletSuggestionsFromState(); });
  getEl("vHi").addEventListener("input", () => { doCalc(); refreshDropletSuggestionsFromState(); });

// rates + swaths + per-rate PSI
["gpa1","gpa2","gpa3","swath1","swath2","swath3","psi1","psi2","psi3"].forEach(id => {
  const el = getEl(id);
  if (el) el.addEventListener("input", () => {
    doCalc();
    refreshDropletSuggestionsFromState();
  });
});

  // Per-rate droplet category (drop1 / drop2 / drop3)
  document.querySelectorAll(".droplet-select").forEach(el => {
    el.addEventListener("change", () => {
      doCalc();
      refreshDropletSuggestionsFromState();
    });
  });

// family (global sizing mode / family choice)
["family"].forEach(id => {
  const el = getEl(id);
  if (!el) return;

  el.addEventListener("change", () => {
    if (id === "family") {
      populateDropletAngles();
    }
    doCalc();
    refreshDropletSuggestionsFromState();
  });
});
  
    // Target Droplet Category -> refresh suggestions on change
  const targetSel = getEl("targetDsc");
  if (targetSel) {
    targetSel.addEventListener("change", () => {
      refreshDropletSuggestionsFromState();
    });
  }

// pattern + family dropdowns (event delegation)
getEl("tbody").addEventListener("change", (evt) => {
  const t = evt.target;
  if (!t) return;

  // Pattern select
  if (t.classList.contains("pattern-select")) {
    const idx = parseInt(t.dataset.rateIdx || "0", 10);
    if (!idx) return;
    const val = t.value;
    if (val === "opt" || PATTERNS.some(p => p.id === val)) {
      patternOverrides[idx] = val;
    } else {
      delete patternOverrides[idx];
    }
    doCalc();
    refreshDropletSuggestionsFromState();
    return;
  }

  // Nozzle family select
  if (t.classList.contains("family-select")) {
    const idx = parseInt(t.dataset.rateIdx || "0", 10);
    if (!idx) return;

    const modeSel    = getEl("family");
    const sizingMode = (modeSel && modeSel.value === "multi") ? "multi" : "single";
    const famValue   = t.value || "";

  if (sizingMode === "single") {
    // In single-nozzle mode, any row change is a global override
    globalFamilyOverride = famValue;
    // Keep all row dropdowns in sync
    document.querySelectorAll("#tbody .family-select").forEach(sel => {
      sel.value = famValue;
    });
  } else {
    // In multi-nozzle mode:
    //  - a non-empty value sets a per-row family override
    //  - "Best Fit (Any Family)" (empty) clears the override
    if (famValue) {
      rowFamilyOverrides[idx] = famValue;
    } else {
      delete rowFamilyOverrides[idx];
    }
  }

  doCalc();
  refreshDropletSuggestionsFromState();
  }
});



  // Open Droplet Model button
  const openDropletBtn = getEl("openDropletTool");
  if (openDropletBtn) {
    openDropletBtn.addEventListener("click", () => {
      // adjust path if needed
      window.open("DropletData GC - Calculator_Find Nozzle.html", "_blank");
    });
  }
 
  // Gauge vs nozzle PSI toggle for droplet suggestions
  const useGaugeEl = getEl("useGaugePsi");
  if (useGaugeEl) {
    useGaugeEl.addEventListener("change", () => {
      refreshDropletSuggestionsFromState();
    });
  }


  // NOTE: no more "Suggest Nozzles" button – table updates automatically
});




